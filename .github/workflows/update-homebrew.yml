name: Update Homebrew Tap

on:
  release:
    types: [published]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tmx repository
        uses: actions/checkout@v4
        with:
          path: tmx

      - name: Extract release information
        id: release
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: hantianjz/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update Homebrew formula
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          chmod +x tmx/.github/scripts/update-homebrew-formula.sh
          tmx/.github/scripts/update-homebrew-formula.sh "$TAG" homebrew-tap

      - name: Commit and push changes
        working-directory: homebrew-tap
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/tmx.rb
          git commit -m "Update tmx to $VERSION"
          git push

      - name: Create PR (optional alternative to direct push)
        if: false  # Set to true if you prefer PRs instead of direct pushes
        working-directory: homebrew-tap
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          VERSION="${{ steps.release.outputs.version }}"
          BRANCH_NAME="update-tmx-${VERSION}"

          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"

          gh pr create \
            --title "Update tmx to $VERSION" \
            --body "Automated update of tmx formula to version $VERSION" \
            --base main \
            --head "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
